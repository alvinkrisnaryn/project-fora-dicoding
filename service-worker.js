import{getAllStories}from"./scripts/utils/indexedDB.js";const CACHE_NAME="fora-app-v1",urlsToCache=["/","/index.html","/[name].[contenthash].css","/[name].[contenthash].bundle.js","./images/logo.png","./images/favicon.png","/manifest.json"];self.addEventListener("install",(e=>{console.log("Service Worker: Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("Service Worker: Caching files",urlsToCache),e.addAll(urlsToCache).catch((e=>{console.error("Service Worker: Cache addAll failed:",e),urlsToCache.forEach((e=>{fetch(e).catch((t=>console.error(`Failed to fetch ${e}:`,t)))}))}))))))})),self.addEventListener("activate",(e=>{console.log("Service Worker: Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME)return console.log("Service Worker: Deleting old cache:",e),caches.delete(e)}))))))})),self.addEventListener("fetch",(e=>{e.request.url.includes("story-api.dicoding.dev/stories")?e.respondWith(caches.open("api-cache").then((t=>fetch(e.request).then((a=>("GET"===e.request.method&&t.put(e.request,a.clone()),a))).catch((async()=>{const a=await t.match(e.request);if(a)return a;try{const e=await getAllStories();if(e&&e.length>0)return new Response(JSON.stringify({listStory:e}),{headers:{"Content-Type":"application/json"}})}catch(e){console.error("IndexedDB fallback failed:",e)}return new Response("API unavailable",{status:503})}))))):e.respondWith(caches.match(e.request).then((t=>t||fetch(e.request).catch((()=>caches.match("/index.html"))))))})),self.addEventListener("push",(function(e){let t;try{t=e.data?e.data.json():{}}catch(a){console.warn("Data push bukan JSON valid, menggunakan default:",a),t={title:"Notifikasi Fora",body:e.data?e.data.text():"Ada notifikasi baru!"}}const a=t.title||"Notifikasi Fora",n={body:t.body||"Ada notifikasi baru!",icon:"/public/images/logo.png",badge:"/public/images/favicon.png"};e.waitUntil(self.registration.showNotification(a,n))})),self.addEventListener("notificationclick",(function(e){e.notification.close(),e.waitUntil(clients.openWindow("/"))}));